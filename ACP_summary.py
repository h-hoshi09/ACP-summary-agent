#ライブラリのインストール
import streamlit as st
from openai import OpenAI
import os
import io
import soundfile as sf 
import subprocess

#APIキーを設定
client = OpenAI(api_key=os.getenv("OPENAI_API_KEY"))
st.title("仮想ACP記録エージェント")

# チャット履歴を保存
if "messages" not in st.session_state:
    st.session_state.messages = [{"role": "system", "content": "あなたは親切なアシスタントです。"}]

def summarize_with_example(transcript):
    prompt = f"""
以下の箇条書きは仮想ACP会話を要約するときに必要な項目を記述したものです。

1.本人が楽しみにしている事、趣味
2.病気や怪我に対する理解
3.本人の治療に対する希望
4.心配している事
5.本人の動向
6.支えになる人、代わりに意思決定できる人
7.状況変化に応じて見直す事
8.退院後の希望
9.今後病院側がやる事

会話を書き起こしたテキストを読んでそれぞれの項目をまとめてください。会話内で項目に該当する所が無い場合、「該当する会話なし」と記述してください。
以下に一つの会話例とその要約を提示します。この例を参考にアップロードされたテキストを要約してください。なお、アップロードされたテキストがACP会話ではない
と判断した場合、「ACP会話のテキストをアップロードしてください」と出力してください。

[会話]
[00:00.000 --> 00:05.320] こんにちは。今、大丈夫ですか?お時間。
[00:05.320 --> 00:07.040] はい、大丈夫です。
[00:07.040 --> 00:13.080] お子さん、お席とか、体調の方どうですか?
[00:13.080 --> 00:17.520] 席は出ますね。夜になると、特に出ます。
[00:17.520 --> 00:22.840] 苦しさは、席が出るとありますけど、席が出なかったら、まあ、なんとか大丈夫です。
[00:22.840 --> 00:28.040] 良かったです。席止めとかも使ってますか?
[00:28.040 --> 00:32.120] はい、先生から出してもらって、飲んでます。
[00:32.120 --> 00:39.760] 今、なんか入院してて、辛いこととか、困っていることとかはないですか?
[00:39.760 --> 00:47.120] 先生が手術した方がいいって言うんですけど、迷ってるんですよね。
[00:47.120 --> 00:57.600] 迷いますよね。今までは、大きい手術とか、そういうのがされたことないんでしたか?
[00:57.600 --> 01:00.640] ないですね。
[01:00.640 --> 01:09.280] そしたら、やっぱり緊張するっていうか、怖いような思いとかもありますよね。恐怖感というか。
[01:09.280 --> 01:26.720] 今も杖で歩いてるだけで、遠出はできないし、これ以上自分の動ける範囲が狭くなったら、家族にも迷惑かけるし、心配ですね。
[01:27.680 --> 01:36.360] 先生からは、どういうふうに、あの、説明を受けてるんですか?その病気のことは。
[01:36.360 --> 01:49.520] 先生は、手術受けましょうっては言ってるんですけど。
[01:49.520 --> 01:57.000] あんまり気持ちが手術に、今は向いてないっていう感じですかね。
[01:57.000 --> 02:00.000] そうですね。
[02:00.000 --> 02:09.680] なんか、入院前は、こういうことが楽しいんで、お趣味にしてることとかはあったんですか?
[02:09.840 --> 02:21.240] そう、登山が好きで、山に登ってたんですけど、呼吸が苦しくなっちゃって、できなくなっちゃったんですよね。
[02:21.240 --> 02:24.800] 登山は何年くらい続けてたんですか?
[02:24.800 --> 02:31.840] そうですね。40くらいからだから、30年間くらいですか。
[02:31.840 --> 02:33.320] すごいですね。
[02:33.320 --> 02:34.320] はい。
[02:39.680 --> 03:05.840] 息子も2人いるんだけど、2人とも仕事が忙しいし、1人は東京だし、あんまり会手にならないですしね、迷惑もかけたくない気持ちが強いです。
[03:06.000 --> 03:15.760] 息子さんは、今回のご病気のことって知ってるんですか?
[03:15.760 --> 03:24.160] 一応、それぞれには話したんですけど、やっぱり忙しくて、家族で話し合う時間は取れてないですね。
[03:24.160 --> 03:36.480] そうなんですね。今はご自身の身の周りのことをされているのは奥さん?
[03:36.480 --> 03:45.680] そうですね。全部やってはくれてますけど、妻も腰が痛くて動けない時もあるんですよ。
[03:45.680 --> 03:53.280] あ、そうなんですか。腰が痛いと家事とか家のこととかも大変ですよね。
[03:53.280 --> 04:03.600] そうなんですよ。それもあって、自分が手術を受けて、その後のことがちょっと心配ですね。
[04:03.600 --> 04:15.920] 確かにそうですね。奥様は他に頼れる方というか、長男・次男さん以外にそういうのを相談できる方とかいるんですかね?
[04:15.920 --> 04:23.120] いやー、いないですね。
[04:23.120 --> 04:30.160] 本人のことも奥さんのことも心配ですよね。
[04:30.160 --> 04:32.160] そうなんですよ。
[04:32.160 --> 04:45.680] 手術に積み込めない理由に、家族のこととか本人の体のことだけじゃなくて、そういう心配とかもあったりしますか?
[04:45.680 --> 04:47.680] ありますね。
[04:48.640 --> 04:59.520] 何とか長男・次男さんと含めてお話しできる機会があるといいんですけどね、なかなか帰ってこられないんですかね?
[04:59.520 --> 05:04.320] そうなんですよね。やっぱりみんなで話し合った方がいいですかね。
[05:04.320 --> 05:34.240] そうですね。家族の意見も聞いた上で、本人がどのように選択するか、あとはサポートしてくれる方だけがどう考えるかというのはすごく大事なので、そういう機会を持てるのであればあった方がいいと思うんですけど、ただお仕事でお忙しいということなので。
[05:34.720 --> 05:39.120] お電話とかでもお話しできるといいですけどね。
[05:39.120 --> 05:49.920] とりあえず、次男が市内にいるので、ちょっと休みの日に来てもらって、退院したら話してみます。
[05:49.920 --> 06:18.720] ああ、ぜひぜひそうしてみてください。その結果のお話も聞かせていただきたいと思うんですけども、手術を受けた後に体力が落ちたり、今まで楽しみにしてた、前に庭いじりとかもされるというふうに聞いたことがあるんですけど、
[06:18.720 --> 06:23.680] そういうのもできるといいですよね。
[06:23.680 --> 06:30.880] はい。そこまで回復できれば、しっかり治療したいと思います。
[06:30.880 --> 06:34.160] そうですね。
[06:34.160 --> 06:45.520] リハビリとか、時間かかっても受ければ、そこまで回復、今と同じくらい受けるようになりますかね。
[06:45.520 --> 07:07.280] リハビリの方たちもいろんな患者さんのサポートしているので、高橋さんの体調全体のことを見ながら徐々にサポートしてくれると思いますので、大丈夫だと思います。
[07:07.280 --> 07:24.560] あとは先生と私たち看護師もお時間を許す限りいろんなお話を聞いていきたいと思っているので、心配なことがあったら何でもお話していただきたいなと思っています。
[07:24.560 --> 07:38.800] ちょっとこちらから少し心配なことがあったんですけど、糖尿病をもともと持っていらっしゃるということで、今そっちの方ってどうなんですかね。
[07:38.800 --> 07:54.240] 糖尿病は特にたくさん食べたりとかしてないんですけどね、あんまり先生は良くない、良くないって言うんですよね。飲み薬は飲んでますよ。
[07:54.240 --> 08:17.600] そうなんですね。手術を受けるとなると、その辺の血糖値のコントロールとかも少し考えていかなくちゃいけなくなるので、今とにかく手術を受けるのがちょっと怖いという状況でこんなお話するのもあれなんですけど、
[08:17.600 --> 08:26.000] その辺も一緒に考えていけたらなと思うんですけど、病院の食事どうですか?
[08:26.000 --> 08:27.600] 薄いですね。
[08:27.600 --> 08:35.360] そうですよね。きっと今、数値が少しいいかもしれないですね。
[08:35.360 --> 08:39.920] やっぱりこれぐらいしないとダメなんですね。
[08:39.920 --> 08:46.880] もしそうなら頑張って食事も制限します。
[08:46.960 --> 08:58.560] ただ作っているのは妻なので、ちょっと妻の方にも何か教えてもらえたらなって思います。
[08:58.560 --> 09:07.520] 栄養士の指導も受けられるようになっているので、どうですか?ご家庭のお食事って濃い味だったりしますか?
[09:07.520 --> 09:15.040] やっぱり僕が濃いのが好きなので、濃いですね。
[09:15.040 --> 09:22.400] そうなんですね。そしたらその辺もこちらで調整してみますね。
[09:22.400 --> 09:24.400] 栄養士さんにお話しして。
[09:24.400 --> 09:26.400] お願いします。
[09:27.360 --> 09:47.440] つえ方向で普段ご自宅で生活していた時は、お友達と集まったりとか、他の人と関わるようなご趣味というか、そういうイベントとかあったりしましたか?
[09:47.680 --> 09:58.880] 仕事をやめてからは、あまり友達とかで会う機会はないですね。家にいることが多いです。
[09:58.880 --> 10:02.320] じゃあ大体接するのは奥さんがほとんど?
[10:02.320 --> 10:04.320] そうです。
[10:05.200 --> 10:32.880] 手術を受けた後にいろんな楽しみを持っていただきたいので、地域でデイサービスとかあまり聞くとまだまだ大丈夫だよって思う方が多いんですけど、そういう機会とかもいろいろあるので、普段接しない人と接して逆に一人ずつになっちゃう人もいるかもしれないんですが、
[10:32.880 --> 10:40.480] もしご興味あったらそういうこともご提案できるので、そちらの方にもお話ししてもらえたらと思います。
[10:40.480 --> 10:43.120] 運動とかできるならいいですね。
[10:43.120 --> 10:52.560] そうですね。デクリエーションとかもあるからゲーム感覚でみんなで体を動かしたりとかそういうこともあります。
[10:52.720 --> 11:08.720] ただ今は手術のことが決まらないとご自身でもあれかもしれないんですけど、ご自身で一番大事にしていることって何かありますか?
[11:08.720 --> 11:11.760] そうですね。
[11:11.760 --> 11:22.000] あまり家族に迷惑をできればかけたくない。
[11:22.000 --> 11:30.640] その中で、やっぱり回復はしたいです。
[11:30.640 --> 11:34.400] うんうんうん。そうですよね。
[11:34.400 --> 11:38.400] 家に帰りたいです。
[11:39.040 --> 11:47.040] ちなみに、高石さん、奥さんと結婚されたのっていくつくらいになるんですか?
[11:47.040 --> 11:57.040] 結婚したのは、そうですね、若い時から知ってました。
[11:57.040 --> 12:08.080] 長年ね、やっぱり連れ添ってくれている奥さんに迷惑かけたくないとか、そういう思いが強いんですかね。
[12:08.240 --> 12:20.720] そうですね。息子たちも忙しいし、妻も高齢だし腰も悪いし、できればあんまり迷惑はかけたくないですね。
[12:20.720 --> 12:22.720] そうですよね。
[12:23.360 --> 12:25.360] はい。
[12:25.360 --> 12:27.360] そうかそうか。
[12:27.360 --> 12:29.360] 奥さん、そうですね。
[12:33.360 --> 12:47.360] なんか、市内に住んでいる事男さん、子育てが忙しいということだったんですけど、奥さんとのご関係というか、その、切りの?
[12:47.360 --> 12:49.360] お嫁さんですか?
[12:49.360 --> 12:51.360] お嫁さんもね、お仕事してるんですよ。
[12:52.000 --> 12:56.000] なので、夫は二人で頑張ってますよ。
[12:56.000 --> 12:58.000] そうなんですね。
[12:58.000 --> 13:12.000] お子さんいると、なかなかね、こっちのというかね、高齢さんの家の事までというのは難しいですね。
[13:12.640 --> 13:26.640] そしたら、きっと奥さんの負担が軽減することが高齢さん自身の、ちょっと、気持ちが楽になるというか、そういうことにつながるですね。素敵ですね。
[13:26.640 --> 13:28.640] はい。いえいえ、そんな。
[13:32.640 --> 13:40.640] 奥さん、腰の方ね、少し負担なく家事とかできればいいんですけどね。
[13:41.280 --> 13:43.280] そうですね。
[13:43.280 --> 14:05.280] もし、さっきのデイサービスの話じゃないですけれども、どうしてもね、奥さんの腰の状態が悪くなったりとかした時は、ヘルパーさんとかが家事をサポートしてくれるようなサービスとかもあるので、その退院の時の状況にはよると思うんですけどね。
[14:05.920 --> 14:29.920] ただ、そうですね、もともと渡算されていたので、高齢さんはきっと基礎体力あると思うので、手術、家族と話し合って前向きに検討していただければ、せっかくこのぐらいの状況で見つかったということなので、
[14:30.560 --> 14:42.560] なぁとは思いますが、すぐに決められることではないので、時間をかけて相談していければなぁと思いますね。
[14:42.560 --> 14:44.560] そうですね。
[14:47.560 --> 14:58.560] なんか気がかりなこととか、ご家族のこと以外にあんまり話せないこととかはないですか?
[15:00.560 --> 15:05.560] 時々は美味しいものが食べたいですね。
[15:05.560 --> 15:07.560] そうですよね。
[15:07.560 --> 15:13.560] どうによるよっていって、いろいろ制限されていたらちょっとストレスですし、
[15:13.560 --> 15:15.560] 手術の時は頑張りますよね。
[15:15.560 --> 15:17.560] そうですね。
[15:17.560 --> 15:21.560] だけど元気になったら美味しいものも食べたいですね。
[15:22.200 --> 15:35.200] 手術が無事に終わったらみんなで美味しいものを食べたい、約束、イベントなんか作って、それを楽しみにというのもいいですね。
[15:35.200 --> 15:37.200] そうですね。おまごと一緒に食べたいですね。
[15:37.200 --> 15:39.200] そうですね。おまごさんも。
[15:39.200 --> 15:41.200] おまごさん何人いらっしゃるんですか?
[15:41.200 --> 15:43.200] 3人です。
[15:43.200 --> 15:45.200] 賑やかでいいですね。
[15:45.200 --> 15:47.200] はい。
[15:47.840 --> 15:53.840] そういうおまごさんの性格とかも楽しいですよね。
[15:53.840 --> 15:55.840] ついていきたいですね。
[15:55.840 --> 15:57.840] そうですよね。
[15:57.840 --> 16:06.840] そうなるとちょっとおじいちゃん頑張って手術受けてもらいたいなという気持ちはありますけどね。
[16:06.840 --> 16:10.840] そうでも強制することじゃないので。
[16:10.840 --> 16:14.840] 今度、奥さんいつ来られるんですか?
[16:15.480 --> 16:17.480] 明日着替え取りに来るって言ってました。
[16:17.480 --> 16:26.480] そうなんです。入院中こういう機会もないといろんな話ができないと思うので、
[16:26.480 --> 16:34.480] もし高橋さんが大丈夫、そうだったら今の不安な気持ちとか、
[16:34.480 --> 16:43.480] 考えていること、手術迷ってるよというお話とか、奥さんに話してみてもいいんじゃないかなって思います。
[16:44.120 --> 16:46.120] そういう話をしています。
[16:46.120 --> 16:53.120] あまり夫婦って恥ずかしいですよね。そういう正直な気持ちとか。
[16:53.120 --> 16:55.120] そうですね。
[16:55.120 --> 17:03.120] ただ、きっと高橋さんが奥さんのこと心配されてというのが伝われば、
[17:03.120 --> 17:11.120] 奥さんの気持ちもまたそうありたりするかもしれないかなと思う。
[17:11.760 --> 17:16.760] 話しづらかったら、こちらからお話しすることもできますし、
[17:16.760 --> 17:19.760] ちょっとお話が助かります。
[17:19.760 --> 17:24.760] なんか恥ずかしくて、あんまり話せないと思うから、
[17:24.760 --> 17:28.760] 高橋さんがこういうことを聞いてくれたら。
[17:28.760 --> 17:30.760] そうですね。
[17:30.760 --> 17:36.760] 本当は直接話していただいた方が気持ちは伝わるんですけど、
[17:37.400 --> 17:44.400] 最初の導入として、こういうふうに思ってるみたいですよというのがこちらから伝えられるので、
[17:44.400 --> 17:47.400] ちょっとお話ししてみようかなと思います。
[17:47.400 --> 17:49.400] お願いします。
[17:49.400 --> 17:51.400] 分かりました。
[17:51.400 --> 17:57.400] 今日はお時間いただいてありがとうございます。
[17:57.400 --> 18:04.400] また気軽にご相談していただければと思うので。
[18:04.400 --> 18:06.400] 分かりました。
[18:07.040 --> 18:10.040] ちょっとなんか言い残したこととかないですか?
[18:10.040 --> 18:14.040] 言い残したことですか?
[18:18.040 --> 18:20.040] 大丈夫です。
[18:23.040 --> 18:26.040] じゃあ、あった奥さんにちょっとお話ししてみますね。
[18:26.040 --> 18:28.040] はい、よろしくお願いします。
[18:28.040 --> 18:30.040] 失礼します。

[要約]
患者さん：高橋さん

1.本人が楽しみにしている事、趣味：
・登山を30年間続けていた。
・庭いじりをしていた。回復できればまた楽しみたい。
・元気になれば3人の孫と美味しいものが食べたい。

2.病気や怪我に対する理解:
・持病の糖尿病に関しては医師からの説明を理解しており、血糖値のコントロールのためなら食事を制限する意向がある。

3.本人の治療に対する希望:
・また趣味や楽しみにしていることが出来るまで回復できるようにしっかり治療する意向がある。
・出来れば家族に迷惑をかけたくないが、その中で回復を望まれている。

4.心配している事: 
・医師には手術を進められているが、大きい手術を受けたことがないため、迷われている。今は気持ちが手術に向いていない。
・杖が無ければ歩行できないため、家族に迷惑をかけることを心配されている。
・息子２人には病気のことを話したが、それぞれが忙しく家族で話し合う時間は取れていない。
・身の回りのことは奥さんがやってくれているが、奥さんも腰痛を抱えていて動けない時もあるため、自身が手術を受けることにより奥さんに負担をかけることを心配されている。
・奥さんに２人の息子以外に頼ったり相談出来る方がいないため、心配されている。

5.本人の動向
・次男は市内にいるため、休みの日に来てもらって退院したら話し合う意向がある。
・一番大切にしていることは「家族の迷惑にならないこと」。
・手術に関しては家族と時間をかけて相談していく意向がある。
・奥さんと直接話すのは恥ずかしいが、看護師を通じてなら自身の気持ちを伝えられるとおっしゃっている。

6.支えになる人、代わりに意思決定できる人:
・病気の事を知っている息子が２人いるが、二人とも仕事が忙しい。そのうちの一人は東京で離れて暮らしているのであまりあてにはならない。
・奥さんが高橋さんの身の回りのことをされている


7.状況変化に応じて見直す事:
・奥さんの腰痛の状態によってはヘルパーなどのサービスの利用も考慮している。

8.退院後の希望：
・運動などができるならデイサービスの利用も希望する。
・家に帰って生活したい。

9.今後病院側がやること：
・高橋さんと息子さんの話し合いの結果について聞く。
・リハビリの担当者が高橋さんの体調全体のことを見ながら徐々にサポートする。
・奥さんに栄養士の指導を受けてもらい、健康的な食事を食べてもらえるようにする。
・高橋さんと奥さんがお互いの気持ちを伝え合う相談をするための導入として奥さんに高橋さんの気持ちを伝える。

{transcript}

""".strip()

    response = client.chat.completions.create(
        model="gpt-4.1",
        messages=[
            {"role": "user", "content": prompt}
        ]
    )
    return response.choices[0].message.content.strip()


#音声ファイルのアップデートと書き起こし
st.subheader("音声ファイルをアップロードして要約")

audio_file = st.file_uploader("音声ファイルを選択（mp3, wav, m4a）", type=["mp3", "wav", "m4a"], key="audio")

if audio_file is not None:
   
    with open("temp_audio.wav", "wb") as f:
        f.write(audio_file.read())
    
    if st.button("書き起こし実行"):
        # 外部スクリプト（別環境）で書き起こし
        result = subprocess.run(["python", "transcribe.py", "temp_audio.wav"])
        
        if os.path.exists("transcript.txt"):
            with open("transcript.txt", "r", encoding="utf-8") as f:
                transcript_text = f.read()
                st.text_area("書き起こし結果", transcript_text, height=200)
        
            # チャット履歴に送信
                st.session_state.messages.append({"role": "user", "content": transcript_text})
                response = client.chat.completions.create(
                    model="gpt-4",
                    messages=st.session_state.messages
                )
                reply = response.choices[0].message.content
                st.session_state.messages.append({"role": "assistant", "content": reply})
                st.markdown(f"**アシスタント:** {reply}")
        
        else:
            st.error("書き起こしに失敗しました。")

#テキストファイルのアップロード
st.subheader("テキストファイルをアップロードして要約")
text_file = st.file_uploader("テキストファイルを選択（.txt）", type=["txt"], key="text")

if text_file is not None and st.button("テキストファイルを要約"):
    file_content = text_file.read().decode("utf-8")
    
    st.session_state.messages.append({"role": "user", "content": file_content})

    # 表示切り替えチェックボックス（デフォルト: False）
    show_text = st.checkbox("アップロードしたテキストの内容を表示する", value=False)
    
    if show_text:
        st.text_area("アップロード内容", file_content, height=150)

    summary = summarize_with_example(file_content)
    st.session_state.latest_summary = summary

if "latest_summary" in st.session_state:
    st.subheader("会話の要約")
    st.text_area("要約", st.session_state.latest_summary,height=800,key="latest_summary_area")

st.subheader("チャット")

# 入力用セッション初期化
if "user_input" not in st.session_state:
    st.session_state.user_input = ""
if "latest_reply" not in st.session_state:
    st.session_state.latest_reply = ""

# 入力フォーム
with st.form("chat_form", clear_on_submit=True):
    st.session_state.user_input = st.text_input("テキストを入力してください：", key="chat_input")
    submitted = st.form_submit_button("送信")

if submitted and st.session_state.user_input:
    # 入力をチャット履歴に追加
    st.session_state.messages.append({"role": "user", "content": st.session_state.user_input})

    # ChatGPTに送信
    response = client.chat.completions.create(
        model="gpt-4.1",
        messages=st.session_state.messages
    )
    reply = response.choices[0].message.content

    # 最新の返答だけ保存
    st.session_state.latest_reply = reply
    # 応答を履歴に追加
    st.session_state.messages.append({"role": "assistant", "content": reply})

# 最新の応答を入力欄の直下に表示
if st.session_state.latest_reply:
    st.markdown("**アシスタントの返答：**")
    st.markdown(f""" {st.session_state.latest_reply}""", unsafe_allow_html=True)

# チャット履歴を表示（古い順）
st.subheader("チャット履歴")
for msg in st.session_state.messages[1:]:  # systemメッセージは除外
    if msg["role"] == "user":
        st.markdown(
            f"""<div style='
                background-color: #1a1a1a;
                color: white;
                padding: 8px 12px;
                border-radius: 10px;
                margin: 2px 0;
                display: block;
                width: fit-content;
                max-width: 80%;
                margin-left: auto;
                text-align: left;
                white-space: pre-wrap;
            '>{msg['content']}</div>""",
            unsafe_allow_html=True
        )
    elif msg["role"] == "assistant":
        st.markdown(f"**アシスタント:** {msg['content']}")
